<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高機能 信号レベルコンバータ (完成版)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f9;
            color: #333;
            display: flex;
            justify-content: center;
        }
        .container {
            width: 100%;
            max-width: 600px;
            background: #fff;
            padding: 25px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        .notes {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 25px;
            text-align: center;
            line-height: 1.5;
        }
        .settings-grid, .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
        }
        .control-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
        }
        .control-group select, .control-group input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
        }
        .row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .row label {
            width: 70px;
            font-weight: 600;
        }
        .row .input-wrapper {
            display: flex;
            flex-grow: 1;
        }
        .row input[type="number"] {
            flex-grow: 1;
            border: 1px solid #ccc;
            border-right: none;
            border-radius: 5px 0 0 5px;
            padding: 10px;
            font-size: 1em;
            outline: none;
            text-align: right;
        }
        .row select {
            border: 1px solid #ccc;
            border-left: none;
            border-radius: 0;
            padding: 10px 5px;
            background-color: #f9f9f9;
        }
        .row .unit {
            padding-left: 10px;
            font-weight: bold;
            min-width: 30px;
        }
        .row input.active {
            background-color: #e0f7fa;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
        }
        .row input:read-only {
            background-color: #f1f1f1;
            color: #777;
        }
        .button-container {
            text-align: center;
            margin-top: 20px;
        }
        button {
            padding: 10px 25px;
            font-size: 1em;
            font-weight: bold;
            color: #fff;
            background-color: #e74c3c;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #c0392b;
        }
        #customImpedanceWrapper { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>高機能 信号レベルコンバータ (完成版)</h1>
        <p class="notes">
            変換したい単位の入力欄をクリックし、値を入力してください。他の単位は自動で計算されます。
        </p>

        <div class="settings-grid">
            <div class="control-group">
                <label for="impedanceSelect">インピーダンス (Z)</label>
                <select id="impedanceSelect">
                    <option value="50">50 Ω</option>
                    <option value="75">75 Ω</option>
                    <option value="600">600 Ω</option>
                    <option value="custom">カスタム...</option>
                </select>
                <div id="customImpedanceWrapper" style="margin-top: 10px;">
                    <input type="number" id="customImpedance" value="50" step="any" min="0.001">
                </div>
            </div>
            <div class="control-group">
                <label for="waveform">波形</label>
                <select id="waveform">
                    <option value="sine" selected>正弦波 (Sine)</option>
                    <option value="square">矩形波 (Square)</option>
                    <option value="triangle">三角波 (Triangle)</option>
                </select>
            </div>
        </div>

        <div class="results-grid-container">
            <div class="row">
                <label for="vrms">Vrms</label>
                <div class="input-wrapper">
                    <input type="number" id="vrms" step="any">
                    <select id="vrmsPrefix"></select>
                </div>
                <span class="unit">V</span>
            </div>
            <div class="row">
                <label for="vpp">Vpp</label>
                <div class="input-wrapper">
                    <input type="number" id="vpp" step="any">
                    <select id="vppPrefix"></select>
                </div>
                <span class="unit">V</span>
            </div>
            <div class="row">
                <label for="dBV">dBV</label>
                 <div class="input-wrapper">
                    <input type="number" id="dBV" step="any">
                </div>
                <span class="unit">dB</span>
            </div>
            <div class="row">
                <label for="dBu">dBu</label>
                 <div class="input-wrapper">
                    <input type="number" id="dBu" step="any">
                </div>
                <span class="unit">dB</span>
            </div>
            <div class="row">
                <label for="dBm">dBm</label>
                 <div class="input-wrapper">
                    <input type="number" id="dBm" step="any">
                </div>
                <span class="unit">dB</span>
            </div>
             <div class="row">
                <label for="power">Power</label>
                <div class="input-wrapper">
                    <input type="number" id="power" step="any">
                    <select id="powerPrefix"></select>
                </div>
                <span class="unit">W</span>
            </div>
        </div>

        <div class="button-container">
            <button onclick="clearAll()">クリア</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fields = {
                vrms: { hasPrefix: true },
                vpp: { hasPrefix: true },
                dBV: { hasPrefix: false },
                dBu: { hasPrefix: false },
                dBm: { hasPrefix: false },
                power: { hasPrefix: true }
            };
            // ★ SI接頭辞を追加
            const prefixOptions = [
                { sym: 'T', val: '1e12' }, { sym: 'G', val: '1e9' }, { sym: 'M', val: '1e6' },
                { sym: 'k', val: '1e3' }, { sym: '', val: '1' }, { sym: 'm', val: '1e-3' },
                { sym: 'µ', val: '1e-6' }, { sym: 'n', val: '1e-9' }, { sym: 'p', val: '1e-12' },
                { sym: 'f', val: '1e-15'}, { sym: 'a', val: '1e-18'}, { sym: 'z', val: '1e-21'},
                { sym: 'y', val: '1e-24'}, { sym: 'r', val: '1e-27'}
            ];
            
            let activeField = null;

            function initialize() {
                Object.keys(fields).forEach(id => {
                    const el = document.getElementById(id);
                    el.addEventListener('focus', () => setActive(id));
                    el.addEventListener('input', () => calculateAndDisplay(id));

                    if (fields[id].hasPrefix) {
                        const prefixSelect = document.getElementById(id + 'Prefix');
                        prefixOptions.forEach(p => {
                            prefixSelect.add(new Option(p.sym, p.val));
                        });
                        prefixSelect.value = '1';
                        prefixSelect.addEventListener('change', () => calculateAndDisplay(id));
                    }
                });
                
                document.getElementById('impedanceSelect').addEventListener('change', handleImpedanceChange);
                document.getElementById('customImpedance').addEventListener('input', () => calculateAndDisplay(activeField));
                document.getElementById('waveform').addEventListener('change', () => calculateAndDisplay(activeField));

                clearAll();
            }

            function handleImpedanceChange(e) {
                const wrapper = document.getElementById('customImpedanceWrapper');
                wrapper.style.display = (e.target.value === 'custom') ? 'block' : 'none';
                if (activeField) calculateAndDisplay(activeField);
            }

            function setActive(id) {
                if (activeField === id) return;
                activeField = id;

                Object.keys(fields).forEach(fieldId => {
                    const inputEl = document.getElementById(fieldId);
                    inputEl.classList.toggle('active', fieldId === id);
                    inputEl.readOnly = (fieldId !== id);
                    if (fieldId !== id) {
                        inputEl.value = '';
                        if(fields[fieldId].hasPrefix) document.getElementById(fieldId + 'Prefix').value = '1';
                    }
                });
            }

            window.clearAll = () => {
                Object.keys(fields).forEach(id => {
                    const inputEl = document.getElementById(id);
                    inputEl.value = '';
                    inputEl.readOnly = true;
                    inputEl.classList.remove('active');
                     if (fields[id].hasPrefix) {
                        document.getElementById(id + 'Prefix').value = '1';
                    }
                });
                activeField = null;
            }

            function getImpedance() {
                const select = document.getElementById('impedanceSelect');
                if (select.value === 'custom') {
                    return parseFloat(document.getElementById('customImpedance').value) || 50;
                }
                return parseFloat(select.value);
            }

            function calculateAndDisplay(sourceId) {
                if (!sourceId) return;
                
                const sourceInput = document.getElementById(sourceId);
                let sourceValue = parseFloat(sourceInput.value);

                if (isNaN(sourceValue)) {
                    Object.keys(fields).filter(id => id !== sourceId).forEach(id => {
                        document.getElementById(id).value = '';
                    });
                    return;
                }

                if (fields[sourceId].hasPrefix) {
                    const prefix = parseFloat(document.getElementById(sourceId + 'Prefix').value);
                    sourceValue *= prefix;
                }

                const Z = getImpedance();
                const waveform = document.getElementById('waveform').value;
                const DBU_REF = 0.775;
                let vrms;

                const vpp_to_vrms_factor = {
                    sine: 1 / (2 * Math.sqrt(2)),
                    square: 1 / 2,
                    triangle: 1 / (2 * Math.sqrt(3))
                };
                
                switch (sourceId) {
                    case 'vrms': vrms = sourceValue; break;
                    case 'vpp': vrms = sourceValue * vpp_to_vrms_factor[waveform]; break;
                    case 'dBV': vrms = Math.pow(10, sourceValue / 20); break;
                    case 'dBu': vrms = DBU_REF * Math.pow(10, sourceValue / 20); break;
                    case 'dBm': vrms = Math.sqrt(Z * Math.pow(10, sourceValue / 10) / 1000); break;
                    case 'power': vrms = Math.sqrt(sourceValue * Z); break;
                    default: return;
                }
                
                if (!isFinite(vrms) || vrms < 0) return;

                const calculations = {
                    vrms: vrms,
                    vpp: vrms / vpp_to_vrms_factor[waveform],
                    dBV: 20 * Math.log10(vrms),
                    dBu: 20 * Math.log10(vrms / DBU_REF),
                    dBm: 10 * Math.log10((vrms * vrms / Z) * 1000),
                    power: (vrms * vrms) / Z
                };

                Object.keys(calculations).forEach(id => {
                    if (id === sourceId) return;
                    
                    const value = calculations[id];
                    const el = document.getElementById(id);

                    if (fields[id].hasPrefix) {
                        autoPrefix(value, id);
                    } else {
                        el.value = isFinite(value) ? value.toPrecision(6) : '';
                    }
                });
            }
            
            // ★ SI接頭辞の選択ロジックを改善
            function autoPrefix(value, inputId) {
                const inputEl = document.getElementById(inputId);
                const prefixEl = document.getElementById(inputId + 'Prefix');

                if (value === 0 || !isFinite(value)) {
                    inputEl.value = '0';
                    prefixEl.value = '1';
                    return;
                }

                const absValue = Math.abs(value);
                const sortedPrefixes = [...prefixOptions].sort((a, b) => parseFloat(b.val) - parseFloat(a.val));
                
                let bestPrefix = sortedPrefixes.find(p => absValue >= parseFloat(p.val));

                if (!bestPrefix) {
                    bestPrefix = sortedPrefixes[sortedPrefixes.length - 1];
                }

                const scale = parseFloat(bestPrefix.val);
                const scaledValue = value / scale;
                
                prefixEl.value = bestPrefix.val;
                inputEl.value = Number(scaledValue.toPrecision(6)).toString();
            }

            initialize();
        });
    </script>
</body>
</html>